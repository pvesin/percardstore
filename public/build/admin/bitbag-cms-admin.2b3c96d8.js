(()=>{"use strict";class e{constructor(e={textField:"data-bb-cms-text",fileField:"data-bb-cms-file"}){this.config=e,this.textField=document.querySelector(`[${e.textField}]`),this.fileField=document.querySelector(`[${e.fileField}]`)}init(){if("object"!=typeof this.config)throw new Error("Bitbag CMS Plugin - HandleCsvUpload class config is not a valid object");this._handleFields()}_handleFields(){this._handleTextField(),this._handleFileField()}_handleTextField(){this.textField.addEventListener("click",(()=>{this.fileField.click()}))}_handleFileField(){this.fileField.addEventListener("change",(e=>{this.textField.value=e.target.files[0].name}))}}const t=(e,t,a)=>{const i=new CustomEvent(`bb.${t}`,{detail:a});return e.dispatchEvent(i),e};class a{constructor(e={wrappersIndicator:"data-bb-cms-wrapper",lockFieldIndicator:"data-bb-cms-toggle-slug",bbTarget:"bitbag_sylius_cms_plugin_page"}){this.wrappers=document.querySelectorAll(`[${e.wrappersIndicator}]`),this.lockFieldIndicator=`[${e.lockFieldIndicator}]`,this.bbTarget=e.bbTarget,this.config=e}init(){if("object"!=typeof this.config)throw new Error("Bitbag CMS Plugin - HandleSlugUpdate class config is not a valid object");if("string"!=typeof this.lockFieldIndicator||"string"!=typeof this.bbTarget)throw new Error("Bitbag CMS Plugin - HandleSlugUpdate class config key values are not valid strings");this._handleFields()}_handleFields(){this.wrappers.forEach((e=>{const t=e.dataset.locale,a=e.querySelector(`#${this.bbTarget}_translations_${t}_name`),i=e.querySelector(`#${this.bbTarget}_translations_${t}_slug`),l=e.querySelector(this.lockFieldIndicator);if(!a||!i||!t)return;let s;a.addEventListener("input",(e=>{e.preventDefault(),i.readOnly||(clearTimeout(s),s=setTimeout((()=>{this._updateSlug(i,a.value)}),1e3))})),l&&l.addEventListener("click",(e=>{e.preventDefault(),this._toggleSlugModification(i,l)}))}))}async _updateSlug(e,a){t(e,"cms.slug.update.start"),e.parentNode.classList.add("loading"),e.value=await this._getValidSlug(e.dataset.url,a),e.parentNode.classList.remove("loading"),t(e,"cms.slug.update.end")}async _getValidSlug(e,t){try{const a=await fetch(`${e}?name=${t}`);return(await a.json()).slug}catch(e){console.error(`BitBag CMS Plugin - HandleSlugUpdate class error : ${e}`)}}_toggleSlugModification(e,t){e.readOnly=!e.readOnly;const a=t.querySelector("i");a.classList.toggle("lock"),a.classList.toggle("unlock")}}class i{constructor(e={previewButton:"data-bb-cms-preview-btn",previewModal:"data-bb-cms-preview-modal",channelSwitch:"data-bb-cms-channel",localeSwitch:"data-bb-cms-locale"}){this.config=e,this.button=document.querySelector(`[${e.previewButton}]`),this.modal=document.querySelector(`[${e.previewModal}]`),this.modalSelector=e.previewModal,this.channelSelector=e.channelSwitch,this.localeSelector=e.localeSwitch}init(){if("object"!=typeof this.config)throw new Error("Bitbag CMS Plugin - HandlePreview class config is not a valid object");if("string"!=typeof this.localeSelector||"string"!=typeof this.channelSelector||"string"!=typeof this.modalSelector)throw new Error("Bitbag CMS Plugin - HandlePreview class config key values are not valid strings");this._resourcePreview()}_$_CKEDITOR_MODAL_SHOW(){return $(`[${this.modalSelector}]`).modal("show")}_$_CKEDITOR_UPDATE_INSTANCES(){[...CKEDITOR.instances].forEach((e=>e.updateElement()))}_resourcePreview(){this.button.addEventListener("click",(e=>{e.preventDefault(),this._$_CKEDITOR_UPDATE_INSTANCES,this._createPreview(),this._$_CKEDITOR_MODAL_SHOW()})),document.querySelector(`[${this.channelSelector}]`).addEventListener("change",(e=>{e.preventDefault(),this._$_CKEDITOR_UPDATE_INSTANCES,this._createPreview(),this._$_CKEDITOR_MODAL_SHOW()})),document.querySelector(`[${this.localeSelector}]`).addEventListener("change",(e=>{e.preventDefault(),this._$_CKEDITOR_UPDATE_INSTANCES,this._createPreview(),this._$_CKEDITOR_MODAL_SHOW()}))}async _createPreview(){this.modal.querySelector(".ui.loadable").classList.add("loading"),this.modal.disabled=!0;const e=document.querySelector(`[${this.channelSelector}]`).value,a=document.querySelector(`[${this.localeSelector}]`).value,i=this.button.dataset.url,l=this.button.closest("form"),s={method:"POST",body:new FormData(l)};try{t(this.modal,"cms.create.preview.start");const l=await fetch(`${i}?_channel_code=${e}&_locale=${a}`,s),r=await l.text(),c=new Blob([r],{type:"text/html",charset:"utf-8"}),n=window.URL.createObjectURL(c);this.modal.querySelector("iframe").src=n,t(this.modal,"cms.create.preview.completed",r)}catch(e){console.error(`BitBag CMS Plugin - HandlePreview class error : ${e}`),t(this.modal,"cms.create.preview.error",e)}finally{this.modal.querySelector(".ui.loadable").classList.remove("loading"),this.modal.disabled=!1,t(this.modal,"cms.create.preview.end")}}}class l{constructor(e={bbMediaContainer:"data-bb-cms-autocomplete",choiceName:"data-bb-cms-choice-name",choiceValue:"data-bb-cms-choice-value",criteriaType:"data-bb-cms-criteria-type",criteriaName:"data-bb-cms-criteria-name",editUrl:"data-bb-cms-load-edit-url",nameMessage:"data-bb-cms-name-message",deleteButton:"data-bb-cms-delete-selected",choosenPreview:"data-bb-cms-selected-image",selectMenu:"data-bb-cms-selection-menu",selectInput:"data-bb-cms-image-select",placeholder:"data-bb-cms-placeholder",limit:30}){this.config=e,this.mediaContainers=document.querySelectorAll(`[${e.bbMediaContainer}]`),this.deleteButton=`[${e.deleteButton}]`,this.selectMenu=`[${e.selectMenu}]`,this.selectInput=`[${e.selectInput}]`,this.placeholder=`[${e.placeholder}]`}init(){if("object"!=typeof this.config)throw new Error("Bitbag CMS Plugin - HandleAutoComplete class config is not a valid object");this.mediaContainers.forEach((e=>{this._handleSavedValue(e),this._handleImageChoice(e),this._handleResetBtn(e)}))}_handleResetBtn(e){const t=e.querySelector(this.deleteButton);""!==e.querySelector("input[type=hidden]").value?(t.classList.remove("is-hidden"),t.addEventListener("click",(()=>{this._resetValues(e)}))):t.classList.add("is-hidden")}_handleImageChoice(e){let t;e.querySelector(this.selectInput).addEventListener("click",(t=>{t.preventDefault(),this._getMediaImages(e)})),e.querySelector(this.selectInput).addEventListener("input",(a=>{a.preventDefault(),clearTimeout(t),t=setTimeout((()=>{this._getMediaImages(e,a.target.value)}),500)})),e.querySelector("input[type=hidden]").addEventListener("change",(t=>{t.preventDefault(),this._handleResetBtn(e)}))}async _handleSavedValue(e){if(""===e.querySelector("input[type=hidden]").value)return;const a=`${e.dataset.bbCmsLoadEditUrl}?${e.querySelector("input[type=hidden]").value.split(",").filter(String).map((e=>`code[]=${e}`)).join("&")}`;try{t(e,"cms.media.saved.reload.start"),e.classList.add("loading");const i=await fetch(a),l=await i.json();this._addToSelectMenu(l,e);let s=[],r=e.querySelector(this.selectMenu);null!==r&&(s=r.children);for(let e of s)e.click();t(e,"cms.media.saved.reload.completed",l)}catch(a){console.error(`BitBag CMS Plugin - HandleAutoComplete class error : ${a}`),t(e,"cms.media.saved.reload.error",a)}finally{e.classList.remove("loading"),t(e,"cms.media.saved.reload.end")}}async _getMediaImages(e,a=!1){const i=e.dataset.bbCmsUrl,l=e.dataset.bbCmsCriteriaType,s=a?`&criteria[search][value]=${a}`:"",r=`${i}&limit=${this.config.limit}&criteria[search][type]=${l}&criteria[search][value]=${s}`;try{t(e,"cms.media.display.start"),e.classList.add("loading");const a=await fetch(r),i=await a.json(),l=i._embedded.items;this._addToSelectMenu(l,e),t(e,"cms.media.display.completed",i)}catch(a){console.error(`BitBag CMS Plugin - HandleAutoComplete class error : ${a}`),t(e,"cms.media.display.error",a)}finally{e.classList.remove("loading"),t(e,"cms.media.display.end")}}_resetValues(e){t(e,"cms.media.reset.start"),e.querySelector("input[type=hidden]").value="",e.querySelector(this.selectMenu).innerHTML="",e.querySelector(this.placeholder).innerHTML="",t(e,"cms.media.reset.end")}_addToSelectMenu(e,a){t(a,"cms.media.display.update.start");const i=a.querySelector(this.selectMenu);i.innerHTML="",null!==e&&e.forEach((e=>{i.insertAdjacentHTML("beforeend",this._itemTemplate(e.path,e.code.trim()))})),t(a,"cms.media.display.update.end")}_itemTemplate(e,t){return`<div class="item" data-value="${t}"><img src="${e}"/><strong>${t}</strong></div>`}}document.querySelector('[data-bb-target="cms-import"]')&&(new e).init(),document.querySelectorAll('[data-bb-target="cms-slug-update"]').length>0&&(new a).init(),document.querySelectorAll("[data-bb-cms-preview-btn]").length>0&&(new i).init(),document.querySelector('[data-bb-target="cms-handle-autocomplete"]')&&(new l).init()})();